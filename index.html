<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crimson iOS (MQTT)</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
  }
  h1 {
    text-align: center;
    padding: 0.5rem;
    background: #222;
    margin: 0;
    font-size: 1.2rem;
  }
  .nodes-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0.5rem;
    gap: 0.5rem;
  }
  .node-card {
    background: #222;
    border: 1px solid #555;
    border-radius: 8px;
    width: 300px;
    height: 220px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .node-header {
    background: #333;
    padding: 0.25rem 0.5rem;
    font-weight: bold;
    text-align: center;
    font-size: 0.95rem;
    border-bottom: 1px solid #555;
  }
  .messages {
    flex: 1;
    padding: 0.25rem 0.5rem;
    overflow-y: auto;
    font-size: 0.85rem;
  }
  .message {
    margin-bottom: 0.2rem;
    border-bottom: 1px solid #444;
    padding-bottom: 0.1rem;
  }
  .timestamp {
    font-size: 0.7rem;
    color: #999;
    margin-left: 0.25rem;
  }
</style>
</head>
<body>

<h1>Crimson iOS - Live Nodes</h1>
<div class="nodes-container" id="nodes-container"></div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const MAX_MESSAGES_PER_NODE = 25;
const container = document.getElementById('nodes-container');
const nodes = {}; // Stores card and messages per node

// Connect to MQTT WebSocket
const client = mqtt.connect('wss://mqtt.meshhubmids.com:1883', {
  username: 'mhmmqtt', // optional
  password: 'mhmmqtt'  // optional
});

client.on('connect', () => {
  console.log('Connected to MQTT');
  client.subscribe('meshtastic/+/text', err => {
    if (err) console.error('Subscription error:', err);
  });
});

client.on('message', (topic, message) => {
  const msgText = message.toString();
  const nodeId = topic.split('/')[1];
  const timestamp = new Date().toLocaleTimeString();

  if (!nodes[nodeId]) {
    const card = document.createElement('div');
    card.classList.add('node-card');
    card.innerHTML = `<div class="node-header">${nodeId}</div><div class="messages"></div>`;
    container.appendChild(card);
    nodes[nodeId] = { card, messages: [] };
  }

  const node = nodes[nodeId];
  node.messages.push({ text: msgText, timestamp });

  if (node.messages.length > MAX_MESSAGES_PER_NODE) {
    node.messages.shift();
  }

  const messagesDiv = node.card.querySelector('.messages');
  messagesDiv.innerHTML = '';
  node.messages.forEach(m => {
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `${m.text} <span class="timestamp">${m.timestamp}</span>`;
    messagesDiv.appendChild(div);
  });

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

client.on('error', err => {
  console.error('MQTT error:', err);
  container.innerHTML = '<p style="color:red;text-align:center;">Error connecting to MQTT server.</p>';
});
</script>

</body>
</html>
    overflow: hidden;
    background-color: #331a00;
    box-shadow: 0 4px 8px rgba(255, 170, 51, 0.5);
    width: 350px;
    min-height: 400px; /* ensures all wrappers have equal height */
  }

  .iframe-wrapper p {
    margin: 5px 5px 0;
    font-weight: bold;
    font-size: 1.2em;
    text-align: center;
    min-height: 2.4em; /* aligns buttons */
  }

  iframe {
    border: none;
    width: 100%;
    height: 300px;
  }

  .toggle-box {
    border: 2px solid #FFAA33;
    border-radius: 8px;
    padding: 20px;
    margin: 0 auto 10px auto;
    width: 95%;
    max-width: 1000px;
    background: linear-gradient(180deg, #331a00, #1a0d00);
    color: #FFAA33;
    box-shadow: 0 4px 8px rgba(255, 170, 51, 0.5);
    text-align: left;
  }

  .toggle-box p { margin: 10px 0; line-height: 1.5em; }
  .toggle-box ul { margin: 10px 0 10px 20px; }

  .hide-button,
  .reset-button {
    margin: 10px 0 15px 0;
    padding: 5px 10px;
    background-color: #ff0000;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 1em;
    box-shadow: 0 4px 8px rgba(255, 0, 0, 0.5);
  }
  .hide-button:hover,
  .reset-button:hover {
    background-color: #cc0000;
  }
</style>
</head>
<body>
<h1>THE DX MEGA MESH</h1>
<h2>Liam Cottle ‚Äì Live Feed</h2>
<h3>Created by SubnetConflict.</h3>
<h3>Nicked by KD.</h3>

<!-- Info box -->
<div style="margin: 20px auto; width: 95%; max-width: 1000px; text-align: center;">
  <div id="info-box" class="toggle-box">
    <h3 style="background-color: #B22222; color: orange; display: inline-block; padding: 5px 10px; border-radius: 5px;">
      ‚ö†Ô∏è Please Consult Your Local Mesh Group And Read Role Guidance Before Selecting The Router Role ‚ö†Ô∏è
    </h3>

    <p><strong>Join the Mesh Hub Midlands Discord:</strong>
      <a href="https://discord.gg/98b377tCBC" target="_blank">https://discord.gg/98b377tCBC</a>
    </p>
    <p><strong>MeshHubMidlands Website:</strong>
      <a href="https://www.meshhubmids.com" target="_blank">www.meshhubmids.com</a>
    </p>

    <p>Settings to ensure visibility on nodes:</p>
    <ul><li><strong>OK to MQTT</strong> is ON</li></ul>

    <p>To have your own node, connect to Liam Cottle‚Äôs MQTT server using:</p>
    <ul>
      <li>Address: mqtt.meshtastic.liamcottle.net</li>
      <li>Username: uplink</li>
      <li>Password: uplink</li>
      <li>Encryption: Yes</li>
      <li>JSON Output: No</li>
      <li>TLS: No</li>
      <li><strong>Ignore MQTT</strong>: OFF</li>
      <li><strong>OK to MQTT</strong>: ON</li>
      <li><strong>Uplink</strong>: ON</li>
    </ul>

    <p>A node with Wi-Fi will be needed, or use Proxy-to-Client Enable. Fixed position recommended.</p>
    <p>I (KD) will add your node once it shows on Liam Cottle‚Äôs map. It may take a while ‚Äì sorry!</p>
  </div>
  <button id="info-toggle" class="hide-button">Hide Info</button>
  <button id="reset-color" class="reset-button">Reset Colour</button>

  <p style="margin-top:15px;">
    <a href="https://willp618.github.io/westmidshelpfullinks" style="color:#FFAA33; text-decoration: underline; font-weight: bold;">üè† Home</a>
  </p>
  <p style="color:#FFAA33; margin-top:15px;"><em>Edited: 14/10/25</em></p>
</div>

<!-- Container for dynamically loaded iframes -->
<div class="container" id="iframe-container">
  <p style="color:#FFAA33;">Loading live nodes‚Ä¶</p>
</div>

<script>
  // --- Load iframe list dynamically from external file ---
  fetch('iframes.html')
    .then(response => response.text())
    .then(html => {
      document.getElementById('iframe-container').innerHTML = html;
    })
    .catch(err => {
      console.error('Failed to load iframe list:', err);
      document.getElementById('iframe-container').innerHTML =
        '<p style="color:red;">Failed to load node list.</p>';
    });

  // --- Toggle info box ---
  const infoBox = document.getElementById('info-box');
  const infoToggleBtn = document.getElementById('info-toggle');
  infoToggleBtn.addEventListener('click', () => {
    const show = infoBox.style.display === 'none';
    infoBox.style.display = show ? 'block' : 'none';
    infoToggleBtn.textContent = show ? 'Hide Info' : 'Show Info';
  });

  // --- Toggle iframe visibility ---
  function toggleIframeVisibility(button) {
    const iframe = button.parentElement.querySelector('iframe');
    const isHidden = iframe.style.display === 'none';
    iframe.style.display = isHidden ? 'block' : 'none';
    button.textContent = isHidden ? 'Hide' : 'Show';
  }

  // --- Colour handling & reset button ---
  const localStorageKey = 'dx_color';
  const savedColor = localStorage.getItem(localStorageKey);

  function applyColor(chosenColor) {
    document.body.style.color = chosenColor;

    function darkenColor(hex, factor = 0.2) {
      let r = parseInt(hex.substr(1, 2), 16);
      let g = parseInt(hex.substr(3, 2), 16);
      let b = parseInt(hex.substr(5, 2), 16);
      r = Math.floor(r * factor);
      g = Math.floor(g * factor);
      b = Math.floor(b * factor);
      return `rgb(${r}, ${g}, ${b})`;
    }

    const darkerBg = darkenColor(chosenColor, 0.2);

    document.querySelectorAll('.iframe-wrapper').forEach(wrapper => {
      wrapper.style.borderColor = chosenColor;
      wrapper.style.boxShadow = `0 4px 8px ${chosenColor}80`;
      wrapper.style.backgroundColor = darkerBg;
    });

    document.querySelectorAll('.toggle-box').forEach(box => {
      box.style.borderColor = chosenColor;
      box.style.boxShadow = `0 4px 8px ${chosenColor}80`;
      box.style.backgroundColor = darkerBg;
      box.style.color = chosenColor;
    });
  }

  if (savedColor) applyColor(savedColor);

  // --- Reset color to default ---
  const resetButton = document.getElementById('reset-color');
  if (resetButton) {
    resetButton.addEventListener('click', () => {
      const defaultColor = '#FFAA33';
      applyColor(defaultColor);
      localStorage.removeItem(localStorageKey);
    });
  }
</script>
</body>
</html>

